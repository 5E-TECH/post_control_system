name: CI/CD Deploy Monorepo (Systemd, Optimized)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: Production

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3️⃣ Setup GitHub App token
      - name: Setup GitHub App token
        uses: tibdex/github-app-token@v1
        id: generate_token
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          repository: 5E-TECH/post_control_system

      # 4️⃣ Install and build FRONTEND (React)
      - name: Build frontend
        working-directory: client
        run: |
          echo "📦 Installing frontend deps..."
          npm ci --omit=dev
          echo "⚙️  Building React app..."
          npm run build

      # 5️⃣ Install and build BACKEND (NestJS)
      - name: Build backend
        working-directory: server
        run: |
          echo "📦 Installing backend deps..."
          npm ci --omit=dev
          echo "⚙️  Building NestJS app..."
          npm run build

      # 6️⃣ Prepare build artifacts (for upload)
      - name: Prepare artifacts
        run: |
          mkdir -p artifacts
          cp -r client/dist artifacts/client
          cp -r server/dist artifacts/server
          cp -r server/package*.json artifacts/server/
          cp -r server/node_modules artifacts/server/node_modules || true

      # 7️⃣ Deploy to remote server
      - name: Deploy to EC2
        run: |
          echo "${{ secrets.SERVER_SSH_KEY }}" > server_key.pem
          chmod 600 server_key.pem

          echo "🚀 Deploying to ${{ secrets.SERVER_IP }}..."
          rsync -avz --delete -e "ssh -i server_key.pem -o StrictHostKeyChecking=no" \
            artifacts/client/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/ubuntu/post_control_system/client/dist

          rsync -avz --delete -e "ssh -i server_key.pem -o StrictHostKeyChecking=no" \
            artifacts/server/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/home/ubuntu/post_control_system/server/dist

          echo "🔁 Restarting Nest app..."
          ssh -i server_key.pem -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            sudo systemctl daemon-reload
            sudo systemctl restart nestapp.service
            sudo systemctl status nestapp --no-pager
          "
